<!DOCTYPE html PUBLIC "-//w3c//dtd html 4.0 transitional//en">
<html><head>


<script type="text/javascript" src="Fan%20timer%20made%20with%20M68HC908%20Nitron_files/analytics.html"></script>
<script type="text/javascript">archive_analytics.values.server_name="wwwb-app6.us.archive.org";archive_analytics.values.server_ms=154;</script>
<link type="text/css" rel="stylesheet" href="Fan%20timer%20made%20with%20M68HC908%20Nitron_files/banner-styles.html">


   <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
   <meta name="Author" content="Wichit Sirichote">
   <meta name="GENERATOR" content="Mozilla/4.77 [en] (Win98; U) [Netscape]">
   <title>Fan timer made with M68HC908 Nitron</title>
</head>
<body><div class="" id="wm-ipp" style="display: none;" lang="en">

<div style="position:fixed;left:0;top:0;width:100%!important">
<div id="wm-ipp-inside">
   <table style="width:100%;"><tbody><tr>
   <td id="wm-logo">
       <a href="http://web.archive.org/web/" title="Wayback Machine home page"><img src="Fan%20timer%20made%20with%20M68HC908%20Nitron_files/wayback-toolbar-logo.html" alt="Wayback Machine" width="110" height="39" border="0"></a>
   </td>
   <td class="c">
       <table style="margin:0 auto;"><tbody><tr>
       <td class="u" colspan="2">
       <form target="_top" method="get" action="/web/form-submit.jsp" name="wmtb" id="wmtb"><input name="url" id="wmtbURL" value="http://www.kmitl.ac.th/~kswichit/hc08fan/hc08fan.html" style="width:400px;" onfocus="this.focus();this.select();" type="text"><input name="type" value="replay" type="hidden"><input name="date" value="20150811212902" type="hidden"><input value="Go" type="submit"><span id="wm_tb_options" style="display:block;"></span></form>
       </td>
       <td class="n" rowspan="2">
           <table><tbody>
           <!-- NEXT/PREV MONTH NAV AND MONTH INDICATOR -->
           <tr class="m">
           	<td class="b" nowrap="nowrap">
		
		    <a href="http://web.archive.org/web/20150205115508/http://www.kmitl.ac.th/%7Ekswichit/hc08fan/hc08fan.html" title="5 Feb 2015">FEB</a>
		
		</td>
		<td class="c" id="displayMonthEl" title="You are here: 21:29:02 Aug 11, 2015">Aug</td>
		<td class="f" nowrap="nowrap">
		
		    Sep
		
                </td>
	    </tr>
           <!-- NEXT/PREV CAPTURE NAV AND DAY OF MONTH INDICATOR -->
           <tr class="d">
               <td class="b" nowrap="nowrap">
               
                   <a href="http://web.archive.org/web/20150205115508/http://www.kmitl.ac.th/%7Ekswichit/hc08fan/hc08fan.html" title="11:55:08 Feb 5, 2015"><img src="Fan%20timer%20made%20with%20M68HC908%20Nitron_files/wm_tb_prv_on.html" alt="Previous capture" width="14" height="16" border="0"></a>
               
               </td>
               <td class="c" id="displayDayEl" style="width:34px;font-size:24px;" title="You are here: 21:29:02 Aug 11, 2015">11</td>
	       <td class="f" nowrap="nowrap">
               
                   <img src="Fan%20timer%20made%20with%20M68HC908%20Nitron_files/wm_tb_nxt_off.html" alt="Next capture" width="14" height="16" border="0">
               
	       </td>
           </tr>
           <!-- NEXT/PREV YEAR NAV AND YEAR INDICATOR -->
           <tr class="y">
	       <td class="b" nowrap="nowrap">
               
                   <a href="http://web.archive.org/web/20140806134221/http://www.kmitl.ac.th/%7Ekswichit/hc08fan/hc08fan.html" title="6 Aug 2014"><strong>2014</strong></a>
               
               </td>
               <td class="c" id="displayYearEl" title="You are here: 21:29:02 Aug 11, 2015">2015</td>
	       <td class="f" nowrap="nowrap">
               
                   2016
               
	       </td>
           </tr>
           </tbody></table>
       </td>
       </tr>
       <tr>
       <td class="s">
           <a class="t" href="http://web.archive.org/web/20150811212902*/http://www.kmitl.ac.th/%7Ekswichit/hc08fan/hc08fan.html" title="See a list of every capture for this URL">59 captures</a>
           <div class="r" title="Timespan for captures of this URL">7 Jun 04 - 11 Aug 15</div>
       </td>
       <td class="k">
       <a href="http://web.archive.org/web/20111201000000/http://www.kmitl.ac.th/%7Ekswichit/hc08fan/hc08fan.html" id="wm-graph-anchor">
       <div id="wm-ipp-sparkline" title="Explore captures for this URL">
	 <img id="sparklineImgId" alt="sparklines" onmouseover="__wm.st(1)" onmouseout="__wm.st(0)" onmousemove="__wm.mv(event,this)" src="Fan%20timer%20made%20with%20M68HC908%20Nitron_files/graph.html" width="500" height="27" border="0">
       <div style="display: none; width: 25px; height: 27px; left: 375px;" class="yt"></div><div style="display: none; width: 2px; height: 27px; left: 398px;" class="mt"></div><div class="yt" style="display: none; width: 25px; height: 27px;"></div><div class="mt" style="display: none; width: 2px; height: 27px;"></div></div>
       </a>
       </td>
       </tr></tbody></table>
   </td>
   <td class="r">
       <a href="#close" onclick="__wm.h();return false;" style="background-image:url(/static/images/toolbar/wm_tb_close.png);top:5px;" title="Close the toolbar">Close</a>
       <a href="http://faq.web.archive.org/" style="background-image:url(/static/images/toolbar/wm_tb_help.png);bottom:5px;" title="Get some help using the Wayback Machine">Help</a>
   </td>
   </tr></tbody></table>
</div>
</div>
<div id="extwaiimpotscp" style="display:none" v="{8078" f="ZXpnd056Z3pNMlE1TFRobFlUY3ROREptT0MxaE9HRTBMVFEyWm1ZM05URTVaR1E0WW4wPQ==" q="f14c0566" c="11.93" i="19.59" u="0.257" s="19082702" w="false" m="BMe=" vn="ytbd2"></div></div>


<!-- BEGIN WAYBACK TOOLBAR INSERT -->
<script type="text/javascript" src="Fan%20timer%20made%20with%20M68HC908%20Nitron_files/disclaim-element.html"></script>
<script type="text/javascript" src="Fan%20timer%20made%20with%20M68HC908%20Nitron_files/graph-calc.html"></script>
<script type="text/javascript">//<![CDATA[
var __wm = (function(imgWidth,imgHeight,yearImgWidth,monthImgWidth){
var wbPrefix = "/web/";
var wbCurrentUrl = "http://www.kmitl.ac.th/~kswichit/hc08fan/hc08fan.html";

var firstYear = 1996;
var displayDay = "11";
var displayMonth = "Aug";
var displayYear = "2015";
var prettyMonths = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
var $D=document,$=function(n){return document.getElementById(n)};
var trackerVal,curYear = -1,curMonth = -1;
var yearTracker,monthTracker;
function showTrackers(val) {
  if (val===trackerVal) return;
  var $ipp=$("wm-ipp");
  var $y=$("displayYearEl"),$m=$("displayMonthEl"),$d=$("displayDayEl");
  if (val) {
    $ipp.className="hi";
  } else {
    $ipp.className="";
    $y.innerHTML=displayYear;$m.innerHTML=displayMonth;$d.innerHTML=displayDay;
  }
  yearTracker.style.display=val?"inline":"none";
  monthTracker.style.display=val?"inline":"none";
  trackerVal = val;
}
function trackMouseMove(event,element) {
  var eventX = getEventX(event);
  var elementX = getElementX(element);
  var xOff = Math.min(Math.max(0, eventX - elementX),imgWidth);
  var monthOff = xOff % yearImgWidth;

  var year = Math.floor(xOff / yearImgWidth);
  var monthOfYear = Math.min(11,Math.floor(monthOff / monthImgWidth));
  // 1 extra border pixel at the left edge of the year:
  var month = (year * 12) + monthOfYear;
  var day = monthOff % 2==1?15:1;
  var dateString = zeroPad(year + firstYear) + zeroPad(monthOfYear+1,2) +
    zeroPad(day,2) + "000000";

  $("displayYearEl").innerHTML=year+firstYear;
  $("displayMonthEl").innerHTML=prettyMonths[monthOfYear];
  // looks too jarring when it changes..
  //$("displayDayEl").innerHTML=zeroPad(day,2);
  var url = wbPrefix + dateString + '/' +  wbCurrentUrl;
  $("wm-graph-anchor").href=url;

  if(curYear != year) {
    var yrOff = year * yearImgWidth;
    yearTracker.style.left = yrOff + "px";
    curYear = year;
  }
  if(curMonth != month) {
    var mtOff = year + (month * monthImgWidth) + 1;
    monthTracker.style.left = mtOff + "px";
    curMonth = month;
  }
}
function hideToolbar() {
  $("wm-ipp").style.display="none";
}
function bootstrap() {
  var $spk=$("wm-ipp-sparkline");
  yearTracker=$D.createElement('div');
  yearTracker.className='yt';
  with(yearTracker.style){
    display='none';width=yearImgWidth+"px";height=imgHeight+"px";
  }
  monthTracker=$D.createElement('div');
  monthTracker.className='mt';
  with(monthTracker.style){
    display='none';width=monthImgWidth+"px";height=imgHeight+"px";
  }
  $spk.appendChild(yearTracker);
  $spk.appendChild(monthTracker);

  var $ipp=$("wm-ipp");
  $ipp&&disclaimElement($ipp);
}
return{st:showTrackers,mv:trackMouseMove,h:hideToolbar,bt:bootstrap};
})(500, 27, 25, 2);//]]>
</script>
<script type="text/javascript">__wm.bt();</script>
<!-- END WAYBACK TOOLBAR INSERT -->


<center><b><font face="Bookman Old Style"><font color="#990000"><font size="+4">HC08
Fan Timer</font></font></font></b>
  <p>Wichit Sirichote,wichit.sirichote@gmail.com 
</p>
</center>

<blockquote><b><font face="Arial,Helvetica"><font color="#993366"><font size="-1">Build 
  a timer with Motorola Nitron MCU and using ICC08 to develop c program. Loader 
  schematic also included. New s-record for 8-pin 68HC908QT2!</font></font></font></b> 
  <br>
  <hr width="100%">
  <br>
  <font face="Arial,Helvetica"><font size="-1">My son got his fan in the bedroom. 
  The fan has mechanical timer for 0-180mins. One day it broken. So I got the 
  idea to use Nitron chip to replace the mechanical timer. Someone may ask me 
  why so complicated timer made by microcontroller chip? Actually we can build 
  a timer with 555 and a 14-stage cmos counter! The 555 runs astable with time 
  constant controlled by RC and for long period timing we can divide the output 
  frequency of 555 by a cmos counter. That was my homebuilt timer 20 Yrs ago. 
  Such circuit needs a number of passive components. We will see the hardware 
  for timer with Motorola Nitron chip, it is only 16-pin MCU and one decoupling 
  cap. All passive components and timing function are replaced with c coding.</font></font> 
  <br>
  <br>
  <center>
    <p><a href="http://www.kswichit.com/hc08fan/hc08fan.pdf"><img src="Fan%20timer%20made%20with%20M68HC908%20Nitron_files/fan.gif" width="586" height="376" border="0"></a> 
    </p>
    <p><b><font face="Arial,Helvetica"><font color="#000099"><font size="-1">Figure 
      1: Complete hardware schematic: Loader and HC08 Fan Timer.</font></font></font></b>
  </p></center>
  <p><b><font face="Arial,Helvetica"><font color="#003300"><font size="-1">Hardware 
    Schematic</font></font></font></b> 
  </p><p><font face="Arial,Helvetica"><font size="-1">The loader circuit is shown in 
    the block. The hardware settings (external clock with high voltage) forces 
    Nitron chip to run in monitor mode. The IRQ(PTA2) ties to pin 2 of MAX232 
    to provide HV signal. The external oscillator is required for 9600 BAUD send/receive 
    monitor command via PTA0. It made with CMOS inverter 74HC04 and xtal 9.8304MHz. 
    PTA1 and PTA4 also are required. The free software loader, PROG08SZ V1.7 can 
    get from <a href="http://www.pemicro.com/ics08/">http://www.pemicro.com/</a>.</font></font> 
  </p>
  <p><font face="Arial,Helvetica"><font size="-1">The HC08 Fan timer circuit is 
    shown below the loader. The Nitron chip is MC68HC908QY4, 16pin PDIP. When 
    using the ICC08 program, you can choose the programming algorithm with QY4, 
    say. R6 is 10k POT B type tied to the AD0, analog input channel0. It used 
    to set time from 0Hr to 5Hrs. The output relay driving circuit is PTA3. A 
    small NPN transistor drives a 12V electromechanical relay. D2 provides a path 
    for back EMF current flowing when Q2 is turned off. C3 is multilayer 0.1uF 
    decoupling cap. The Nitron chip has internal clock, power reset, low voltage 
    detection, watchdog. You may learn more features from Niron Data sheet.</font></font> 
  </p><p><b><font face="Arial,Helvetica"><font color="#003300"><font size="-1">Zero 
    Power Standby</font></font></font></b> 
  </p><p><font face="Arial,Helvetica"><font size="-1">Figure 2 shows a sample schematic 
    featuring zero power standby. By using a push button S1 to make K1's contact 
    closed when S1 was pressed. The K1's contact will close and latch with period 
    setting by R6. When time-out the K1's contact will open thus turns itself 
    power off. To restart timer, just press S1 again.</font></font> <br>
    <br>
  </p><center>
    <p><img src="Fan%20timer%20made%20with%20M68HC908%20Nitron_files/fan2.gif" width="588" height="376"> 
    </p><p><b><font face="Arial,Helvetica"><font color="#000099"><font size="-1">Figure 
      2: Sample hardware schematic with zero power standby.</font></font></font></b>
  </p></center>
  <p><br>
    <br>
  </p><p><b><font face="Arial,Helvetica"><font color="#003300"><font size="-1">Software</font></font></font></b> 
  </p><p><font face="Arial,Helvetica"><font size="-1">As shown in the schematic, we 
    see that the timer circuit has only one 16-pin MCU, so all timing functions 
    are done by program.</font></font> <br>
    &nbsp; 
  <table cols="1" width="100%" border="">
    <tbody><tr> 
      <td><font face="Courier New,Courier">/*</font> 
        <p><font face="Courier New,Courier">&nbsp; timer.c firmware for cheap 
          timer using Nitron chip</font> <br>
          <font face="Courier New,Courier">&nbsp; MC908QY4CP 16-pin MCU</font> 
          <br>
          <font face="Courier New,Courier">&nbsp; compiled with icc08</font> 
        </p><p><font face="Courier New,Courier">&nbsp; Time setting is made by 10k 
          POT, the analog input 0-5V.</font> <br>
          <font face="Courier New,Courier">&nbsp; Time(mins) = (ADC reading *300)/255</font> 
        </p><p><font face="Courier New,Courier">&nbsp; Copyright (c) 2004 Wichit Sirichote, 
          kswichit@kmitl.ac.th</font> 
        </p><p><font face="Courier New,Courier">*/</font> <br>
          &nbsp; 
        </p><p><font face="Courier New,Courier">#include &lt;io908QY4.H&gt;</font> 
        </p><p><font face="Courier New,Courier">#define minute 7200&nbsp;</font> 
        </p><p><font face="Courier New,Courier">// 120 ticks = 1 sec, so 7200 ticks 
          = 1 minute</font> 
        </p><p><font face="Courier New,Courier">char count;</font> <br>
          <font face="Courier New,Courier">char n,timer1;</font> <br>
          <font face="Courier New,Courier">unsigned int timer2,timer3;</font> 
          <br>
          <font face="Courier New,Courier">unsigned char sec;</font> <br>
          <font face="Courier New,Courier">unsigned int min, PV, save_time,set_time;</font> 
          <br>
          <font face="Courier New,Courier">char x1,x2,x3;</font> <br>
          <font face="Courier New,Courier">char minute_pass;</font> 
        </p><p><font face="Courier New,Courier">void disable_timer()</font> <br>
          <font face="Courier New,Courier">{</font> <br>
          <font face="Courier New,Courier">&nbsp;&nbsp; if(set_time &lt;5) PTA 
          &amp;= ~0x8; // off timer</font> <br>
          <font face="Courier New,Courier">}</font> 
        </p><p><font face="Courier New,Courier">void minute_clock(){</font> <br>
          <font face="Courier New,Courier">&nbsp;&nbsp; timer2++;</font> <br>
          <font face="Courier New,Courier">&nbsp;&nbsp; if (timer2 &gt; minute)</font> 
          <br>
          <font face="Courier New,Courier">&nbsp;&nbsp; {timer2 = 0;</font> <br>
          <font face="Courier New,Courier">&nbsp;&nbsp;&nbsp; minute_pass = 1;</font> 
          <br>
          <font face="Courier New,Courier">&nbsp;&nbsp;&nbsp; }</font> <br>
          <font face="Courier New,Courier">}</font> 
        </p><p><font face="Courier New,Courier">void run_timer(){</font> 
        </p><p><font face="Courier New,Courier">&nbsp;&nbsp;&nbsp;&nbsp; if (timer3 
          &gt; 10)</font> <br>
          <font face="Courier New,Courier">&nbsp;&nbsp; {</font> <br>
          <font face="Courier New,Courier">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PTA 
          |= 0x8; // output high relay</font> <br>
          <font face="Courier New,Courier">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (minute_pass 
          == 1)</font> <br>
          <font face="Courier New,Courier">&nbsp;&nbsp; {</font> <br>
          <font face="Courier New,Courier">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
          minute_pass = 0;</font> <br>
          <font face="Courier New,Courier">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
          timer3--;</font> <br>
          <font face="Courier New,Courier">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</font> 
        </p><p><font face="Courier New,Courier">&nbsp;&nbsp; }</font> <br>
          <font face="Courier New,Courier">&nbsp;&nbsp; else</font> <br>
          <font face="Courier New,Courier">&nbsp;&nbsp; {</font> <br>
          <font face="Courier New,Courier">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
          PTA &amp;= ~0x8; // off relay</font> <br>
          <font face="Courier New,Courier">&nbsp;&nbsp; }</font> 
        </p><p><font face="Courier New,Courier">}</font> <br>
          &nbsp; 
        </p><p><font face="Courier New,Courier">char read_ADC()</font> <br>
          <font face="Courier New,Courier">{</font> <br>
          <font face="Courier New,Courier">&nbsp;&nbsp; ADSCR = 0; // read channel 
          0 one time</font> <br>
          <font face="Courier New,Courier">&nbsp; while(!(ADSCR&amp;0x80))</font> 
          <br>
          <font face="Courier New,Courier">&nbsp; ;</font> <br>
          <font face="Courier New,Courier">&nbsp; return ADR;</font> <br>
          <font face="Courier New,Courier">}</font> <br>
          <font face="Courier New,Courier">// 3-point moving average (digital 
          filtering)</font> 
        </p><p><font face="Courier New,Courier">long read_ADC_filter(){</font> <br>
          <font face="Courier New,Courier">&nbsp;&nbsp; PV = read_ADC();</font> 
          <br>
          <font face="Courier New,Courier">&nbsp;&nbsp; x3 = x2;</font> <br>
          <font face="Courier New,Courier">&nbsp;&nbsp; x2 = x1;</font> <br>
          <font face="Courier New,Courier">&nbsp;&nbsp; x1 = PV;</font> <br>
          <font face="Courier New,Courier">&nbsp;&nbsp; PV = (x1+x2+x3)/3;</font> 
          <br>
          <font face="Courier New,Courier">&nbsp;&nbsp; return PV;</font> <br>
          <font face="Courier New,Courier">}&nbsp;</font> 
        </p><p><font face="Courier New,Courier">int read_time_dial(){ // from 0min 
          to 300mins (0 to 5Hrs)</font> <br>
          <font face="Courier New,Courier">&nbsp; long k;</font> <br>
          <font face="Courier New,Courier">&nbsp; k = read_ADC_filter()*300/255;</font> 
          <br>
          <font face="Courier New,Courier">&nbsp; return k;</font> <br>
          <font face="Courier New,Courier">&nbsp; //&nbsp;&nbsp; return read_ADC_filter()/2; 
          // for testing</font> <br>
          <font face="Courier New,Courier">}</font> 
        </p><p><font face="Courier New,Courier">// write new set time if out of set_time 
          +-10mins</font> <br>
          <font face="Courier New,Courier">void write_time(){</font> <br>
          <font face="Courier New,Courier">&nbsp; set_time = read_time_dial();</font> 
          <br>
          <font face="Courier New,Courier">if(save_time&lt;(set_time-10)||save_time&gt;(set_time+10))</font> 
          <br>
          <font face="Courier New,Courier">&nbsp;&nbsp;&nbsp; {save_time = set_time;</font> 
          <br>
          <font face="Courier New,Courier">&nbsp;&nbsp;&nbsp;&nbsp; timer3 = save_time; 
          // reload new set time to timer3</font> <br>
          <font face="Courier New,Courier">&nbsp;&nbsp;&nbsp;&nbsp; timer2 = 0; 
          // reset minute clock</font> <br>
          <font face="Courier New,Courier">&nbsp;}</font> <br>
          <font face="Courier New,Courier">}</font> 
        </p><p><font face="Courier New,Courier">void task_led()</font> <br>
          <font face="Courier New,Courier">{</font> <br>
          <font face="Courier New,Courier">&nbsp;&nbsp; if(++timer1&gt;50)</font> 
          <br>
          <font face="Courier New,Courier">&nbsp; {</font> <br>
          <font face="Courier New,Courier">&nbsp; timer1 = 0;</font> <br>
          <font face="Courier New,Courier">&nbsp;&nbsp;&nbsp;&nbsp; PTA ^= 0x2; 
          // toggle PA1</font> <br>
          <font face="Courier New,Courier">&nbsp; }</font> <br>
          <font face="Courier New,Courier">}&nbsp;</font> 
        </p><p><font face="Courier New,Courier">void main()</font> <br>
          <font face="Courier New,Courier">{</font> <br>
          <font face="Courier New,Courier">&nbsp; OCSTRIM = 0x81; // trim internal 
          oscillator</font> <br>
          <font face="Courier New,Courier">&nbsp; count = n = 0;</font> <br>
          <font face="Courier New,Courier">&nbsp; TMODH = 0x01;</font> <br>
          <font face="Courier New,Courier">&nbsp; TMODL = 0xf4;</font> <br>
          <font face="Courier New,Courier">&nbsp; TSC = 0x46; // run timer&nbsp;</font> 
          <br>
          <font face="Courier New,Courier">&nbsp; DDRA = ~0x1; // PA0 is ADC input</font> 
          <br>
          <font face="Courier New,Courier">&nbsp; DDRB = 0xff;</font> <br>
          <font face="Courier New,Courier">&nbsp; PTAPUE = ~0x81; // osc2 pin 
          is PTA4 I/O&nbsp;</font> <br>
          <font face="Courier New,Courier">&nbsp; ADCLK = 0x40; // ADC clock= 
          fbus/4</font> 
        </p><p><font face="Courier New,Courier">&nbsp;for(;;)</font> <br>
          <font face="Courier New,Courier">&nbsp;{</font> <br>
          <font face="Courier New,Courier">&nbsp; while(!(TSC&amp;0x80))</font> 
          <br>
          <font face="Courier New,Courier">&nbsp; ;</font> <br>
          <font face="Courier New,Courier">&nbsp; TSC &amp;= ~0x80; // clear TOF</font> 
          <br>
          <font face="Courier New,Courier">&nbsp;// PTA ^= 2; // task running 
          ~60Hz so the loop running is 120Hz or 1/120Hz&nbsp;</font> <br>
          <font face="Courier New,Courier">&nbsp; task_led();</font> <br>
          <font face="Courier New,Courier">&nbsp; write_time();&nbsp;</font> <br>
          <font face="Courier New,Courier">&nbsp; minute_clock();</font> <br>
          <font face="Courier New,Courier">&nbsp; disable_timer();</font> <br>
          <font face="Courier New,Courier">&nbsp; run_timer();</font> <br>
          <font face="Courier New,Courier">&nbsp; COPCTL = 0; // clear COP&nbsp;</font> 
          <br>
          <font face="Courier New,Courier">&nbsp; }</font> <br>
          <font face="Courier New,Courier">}&nbsp;</font> 
        </p><p>&nbsp;
      </p></td>
    </tr>
  </tbody></table>
  </p><center>
    <p><b><font face="Arial,Helvetica"><font color="#000099"><font size="-1">Figure 
      3: Firmware source code.</font></font></font></b>
  </p></center>
  <p><font face="Arial,Helvetica"><font size="-1">Main timing is done by TIM counter 
    and TIM modulo registers, TMODL and TMODH. The preset value for both modulo 
    registers is 0x1F4. TIM counter runs with internal bus clock / 64. Suppose 
    the internal bus clock is 3.2MHz, so the input frequency of TIM is then 3.2MHz 
    / 64= 50,000Hz. We need to produce system tick with 10ms or 100Hz, so the 
    modulo register should be 500 or 0x1F4. You may see the TIM setting in the 
    main code.</font></font> 
  </p><p><font face="Courier New,Courier">TMODH = 0x01;</font> <br>
    <font face="Courier New,Courier">TMODL = 0xf4;</font> <br>
    <font face="Courier New,Courier">TSC = 0x46; // run timer</font> 
  </p><p><font face="Arial,Helvetica"><font size="-1">We can test the timer overflow 
    flag and clear it when set. The code will be,</font></font> 
  </p><p><font face="Courier New,Courier">while(!(TSC&amp;0x80))</font> <br>
    <font face="Courier New,Courier">&nbsp; ;</font> <br>
    <font face="Courier New,Courier">&nbsp; TSC &amp;= ~0x80; // clear TOF</font> 
  </p><p><font face="Arial,Helvetica"><font size="-1">The following tasks running below 
    will be executed every 1/100Hz. However we can check the real timer overflow 
    with a given output bit. I used PTA bit 1 to be toggled. I got 60Hz, so the 
    real timing is 120Hz or 100Hz. I used 120Hz as the timing base, so one minute 
    will be 7,200 ticks.</font></font> 
  </p><p><font face="Arial,Helvetica"><font size="-1">The ADC reading is simple code 
    with one time conversion for channel 0. The ADC value was put into 3-point 
    moving average filtering high frequency noise and put into the linear equation 
    to convert ADC reading into minute value.</font></font> 
  </p><p><font face="Courier New,Courier">int read_time_dial(){ // from 0min to 300mins 
    (0 to 5Hrs)</font> <br>
    <font face="Courier New,Courier">&nbsp; long k;</font> <br>
    <font face="Courier New,Courier">&nbsp; k = read_ADC_filter()*300/255;</font> 
    <br>
    <font face="Courier New,Courier">&nbsp; return k;</font> <br>
    <font face="Courier New,Courier">}</font> 
  </p><p><font face="Arial,Helvetica"><font size="-1">The relationship is simple, no 
    offset, so the equation will be slope multiplied with ADC reading.</font></font> 
    <br>
    &nbsp; <br>
    &nbsp; <br>
    <br>
  </p><center>
    <p><img src="Fan%20timer%20made%20with%20M68HC908%20Nitron_files/graph.gif" width="439" height="191"> <br>
      &nbsp; <br>
      &nbsp; 
    </p><p><b><font face="Arial,Helvetica"><font color="#000099"><font size="-1">Figure 
      4: (a) Relationship between ADC reading and Minute (b) drawing for 10k POT.</font></font></font></b> 
  </p></center>
  <p><font face="Arial,Helvetica"><font size="-1">The write time function will reload 
    new set time if the reading was changed beyond hysteresis of +10/-10mins from 
    the current value.</font></font> 
  </p><p><font face="Courier New,Courier">// write new set time if out of set_time 
    +-10mins</font> <br>
    <font face="Courier New,Courier">void write_time(){</font> <br>
    <font face="Courier New,Courier">&nbsp; set_time = read_time_dial();</font> 
    <br>
    <font face="Courier New,Courier">if(save_time&lt;(set_time-10)||save_time&gt;(set_time+10))</font> 
    <br>
    <font face="Courier New,Courier">&nbsp;&nbsp;&nbsp; {save_time = set_time;</font> 
    <br>
    <font face="Courier New,Courier">&nbsp;&nbsp;&nbsp;&nbsp; timer3 = save_time; 
    // reload new set time to timer3</font> <br>
    <font face="Courier New,Courier">&nbsp;&nbsp;&nbsp;&nbsp; timer2 = 0; // reset 
    minute clock</font> <br>
    <font face="Courier New,Courier">&nbsp;}</font> <br>
    <font face="Courier New,Courier">}</font> 
  </p><p><font face="Arial,Helvetica"><font size="-1">The source code was compiled with 
    ICC08, c compiler for HC08. You may get the full function demo version of 
    ICC08 from imagecraft FTP, <a href="ftp://ftp.imagecraft.com/pub/pub/icc08dem.exe">DEMO 
    ICC08.</a></font></font> 
  </p><p><b><font face="Arial,Helvetica"><font color="#003300"><font size="-1">Schematic 
    and s-record for 8-pin 68HC908QT2.</font></font></font></b> <br>
    <br>
  
  <table width="198" border="0">
    <tbody><tr>
      <td><img src="Fan%20timer%20made%20with%20M68HC908%20Nitron_files/Q2.jpg" width="200" height="178"></td>
    </tr>
    <tr>
      <td><font size="-2" face="Arial, Helvetica, sans-serif">MC68HC908QT2-8pin 
        MCU </font></td>
    </tr>
  </tbody></table>
  </p><p><font face="Arial,Helvetica"><font size="-1">I spent my weekend modify the 
    loader circuit and recompile the source code timer.c for the 8-pin MCU, MC68HC908QT2. 
    The MCU chip has user memory ($F800-$FDFF) only 1536 bytes. It is enough for 
    such timer code. The source code for 16-pin timer.c was not modified. Even 
    some code used PORTB, but it does not matter, since the 8-pin has no PORTB. 
    With the ICC we thus need only to specify the start location of flash memory. 
    ICC08 has the predefined for such location, so we just set the chip to QT2. 
    It will set the start location to $F800. <br>
    <br>
    For the loader, you may tie the same function of I/O pins needed for entering 
    monitor mode. Change them from 16-pin to 8-pin, and do not forget to choose 
    the algorithm module for QT2 in the loader software. Figure 5 shows complete 
    hardware schematic of new timer with 8-pin 68HC908QT2. I added pilot lamp 
    to indicate the relay has AC output and timer is running. New s-record for 
    8-pin MCU can be download below. Both hardware use the same source code.</font></font> 
    <br>
    <font face="Arial,Helvetica"><font size="-1"></font></font>&nbsp; <br>
    <font face="Arial,Helvetica"><font size="-1"></font></font>&nbsp; <a href="http://www.kswichit.com/hc08fan/hc08fanQT2.pdf"><img src="Fan%20timer%20made%20with%20M68HC908%20Nitron_files/fan5.gif" width="588" height="374" border="0"></a><br>
    <font face="Arial,Helvetica"><font size="-1"></font></font>&nbsp; <b><font face="Arial,Helvetica"><font color="#000099"><font size="-1">Figure 
    5: Hardware schematic Fan Timer using 8-pin MC68HC908QT2.</font></font></font></b><br>
    <font face="Arial,Helvetica"><font size="-1"></font></font>&nbsp; <br>
    &nbsp;<br>
    <img src="Fan%20timer%20made%20with%20M68HC908%20Nitron_files/Download.gif" width="70" height="20" border="0"> 
  </p><blockquote> 
    <ul>
      <li><b><font face="Arial,Helvetica"><font color="#000066"><font size="-1">Schematic: 
        <a href="http://www.kswichit.com/hc08fan/hc08fan.pdf">hc08fan.pdf</a></font></font></font></b></li>
      <li><b><font size="-1" face="Arial,Helvetica" color="#000066">Schematic: 
        <a href="http://www.kswichit.com/hc08fan/hc08fanQT2.pdf">hc08fanqt2.pdf</a> ( for 8-pin MCU)</font></b></li>
      <li><b><font face="Arial,Helvetica"><font color="#000066"><font size="-1">firmware: 
        <a href="http://www.kswichit.com/hc08fan/timer.c">timer.c</a></font></font></font></b></li>
      <li><b><font face="Arial,Helvetica"><font color="#000066"><font size="-1">HEX 
        file:&nbsp;&nbsp;&nbsp;&nbsp; <a href="http://www.kswichit.com/hc08fan/timer.s19">timer.s19</a></font></font></font></b></li>
      <li><b><font size="-1" face="Arial,Helvetica" color="#000066">HEX file: 
        <a href="http://www.kswichit.com/hc08fan/timer1.s19">timer1.s19</a> (for 8-pin MCU)</font></b></li>
    </ul>
  </blockquote>
  <hr width="100%">
  <br>
  <a href="http://www.kswichit.com/"><img src="Fan%20timer%20made%20with%20M68HC908%20Nitron_files/back.gif" width="20" height="22" border="0"></a> 
  <div align="right">
    <p><i><font face="Arial,Helvetica"><font size="-1">February 22, 
      2004</font></font></i></p>
    <p><em><font size="-1" face="Arial,Helvetica">recovered 17 December 2015 </font></em></p>
  </div>
</blockquote>










</body></html>
<!--
     FILE ARCHIVED ON 21:29:02 Aug 11, 2015 AND RETRIEVED FROM THE
     INTERNET ARCHIVE ON 4:38:11 Dec 17, 2015.
     JAVASCRIPT APPENDED BY WAYBACK MACHINE, COPYRIGHT INTERNET ARCHIVE.

     ALL OTHER CONTENT MAY ALSO BE PROTECTED BY COPYRIGHT (17 U.S.C.
     SECTION 108(a)(3)).
-->